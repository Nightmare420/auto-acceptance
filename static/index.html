<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Импорт Приёмки — MoySklad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; }
    .row { display:flex; gap:14px; align-items:end; flex-wrap:wrap; margin: 8px 0 16px; }
    label { display:block; margin-bottom: 6px; }
    input[type="text"], input[type="number"], input[type="file"] { padding:8px; min-width: 220px; }
    button { padding:8px 14px; cursor:pointer; }
    .muted { color:#666; }
    pre { background:#f7f7f9; padding:12px; border-radius:8px; overflow:auto; }
    .badge { display:inline-block; padding:2px 6px; border-radius:6px; background:#eee; margin-left:6px; font-size:12px;}
  </style>
</head>
<body>
  <h2>Импорт Приёмки в МойСклад</h2>

  <div class="row">
    <div>
      <label><b>Организация</b></label>
      <input id="org" type="text" placeholder="West-parts" />
    </div>
    <div>
      <label><b>Склад</b></label>
      <input id="store" type="text" placeholder="Основной склад" />
    </div>
    <div>
      <label><b>Поставщик (контрагент)</b></label>
      <input id="agent" type="text" placeholder="Ebay" />
    </div>
  </div>

  <div class="row">
    <div>
      <label><b>Валюта</b></label>
      <label><input type="radio" name="currency" value="usd" checked /> Доллар</label>
      <label style="margin-left:10px;"><input type="radio" name="currency" value="kgs" /> Сом</label>
    </div>
    <div id="usdWrap">
      <label><b>Курс $</b></label>
      <input id="usdRate" type="number" step="0.0001" min="0" placeholder="напр., 82" />
    </div>
    <div>
      <label><b>Коэффициент</b> <span class="badge">по умолч. 1.6</span></label>
      <input id="coef" type="number" step="0.01" min="0" value="1.6" />
    </div>
    <div id="shipWrap">
      <label><b>Доставка $/кг</b> <span class="badge">по умолч. 15</span></label>
      <input id="ship" type="number" step="0.01" min="0" value="15" />
    </div>
  </div>

  <div class="row">
    <div>
      <label><b>Файл (.xlsx или .csv)</b></label>
      <input id="file" type="file" />
      <div class="muted">Формат .xls ненадёжный — лучше сохранить в .xlsx</div>
    </div>
    <div>
      <label><b>Заказ поставщику (опц.)</b> <span class="badge">привязка</span></label>
      <input id="poid" type="text" placeholder="UUID ЗП (если нужно)" />
    </div>
  </div>

  <div class="row">
    <button id="previewBtn" type="button">Превью</button>
    <button id="importBtn" type="button">Создать Приёмку</button>
    <span id="hint" class="muted"></span>
  </div>

  <h3>Ответ</h3>
  <pre id="out">—</pre>

<script>
  const curRadios = document.querySelectorAll('input[name="currency"]');
  const usdWrap = document.getElementById('usdWrap');
  const shipWrap = document.getElementById('shipWrap');

  function getCur() {
    for (const r of curRadios) if (r.checked) return r.value;
    return 'kgs';
  }
  function toggleUsd() {
    const isUsd = getCur() === 'usd';
    usdWrap.style.display = isUsd ? '' : 'none';
    shipWrap.style.display = isUsd ? '' : 'none';
  }
  curRadios.forEach(r => r.addEventListener('change', toggleUsd));
  toggleUsd();

  function buildQuery({withPriceParams}) {
    const q = new URLSearchParams();
    const org = document.getElementById('org').value.trim();
    const store = document.getElementById('store').value.trim();
    const agent = document.getElementById('agent').value.trim();
    if (org) q.set('organization_name', org);
    if (store) q.set('store_name', store);
    if (agent) q.set('agent_name', agent);
    q.set('auto_create_products', 'true');
    q.set('auto_create_agent', 'true');

    const currency = getCur();
    q.set('price_currency', currency);
    if (withPriceParams) {
      const coef = parseFloat(document.getElementById('coef').value || '1.6');
      q.set('coef', String(coef));
      if (currency === 'usd') {
        const rate = parseFloat(document.getElementById('usdRate').value);
        if (!rate) throw new Error('Укажите курс доллара');
        q.set('usd_rate', String(rate));
        const ship = parseFloat(document.getElementById('ship').value || '15');
        q.set('shipping_per_kg_usd', String(ship));
      }
    }
    const poid = document.getElementById('poid').value.trim();
    if (poid) q.set('purchase_order_id', poid);

    return q;
  }

  async function callApi(path, withPriceParams) {
    const out = document.getElementById('out');
    const hint = document.getElementById('hint');
    out.textContent = 'Загрузка...';
    hint.textContent = '';

    const f = document.getElementById('file').files[0];
    if (!f) { out.textContent = 'Выберите файл.'; return; }

    let q;
    try {
      q = buildQuery({withPriceParams});
    } catch (e) {
      out.textContent = e.message || String(e);
      return;
    }

    const form = new FormData();
    form.append('file', f);

    const resp = await fetch(`${path}?${q.toString()}`, { method: 'POST', body: form });
    let data;
    try { data = await resp.json(); } catch { data = { error: await resp.text() }; }
    if (!resp.ok) {
      out.textContent = JSON.stringify(data, null, 2);
      return;
    }
    out.textContent = JSON.stringify(data, null, 2);
    if (path.includes('import-invoice-to-supply')) {
      hint.textContent = 'Готово. Документ Приёмки создан.';
    }
  }

  document.getElementById('previewBtn').addEventListener('click', () => callApi('/import-invoice-preview/', true));
  document.getElementById('importBtn').addEventListener('click', () => callApi('/import-invoice-to-supply/', true));
</script>
</body>
</html>
