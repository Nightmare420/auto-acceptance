<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Импорт Приёмки — МойСклад</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f8fafc; --card:#fff; --text:#0f172a; --muted:#64748b; --border:#e2e8f0; --accent:#2563eb; --danger:#ef4444; --ok:#16a34a; --radius:12px; --space:14px; --maxw:1100px; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;display:flex;justify-content:center}
    .container{width:100%;max-width:var(--maxw);padding:24px 16px}
    h2{margin:0 0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;box-shadow:0 1px 2px rgba(16,24,40,.04);margin-bottom:16px}
    .grid{display:grid;gap:var(--space)} .grid-2{grid-template-columns: repeat(2,minmax(0,1fr))} .grid-3{grid-template-columns: repeat(3,minmax(0,1fr))}
    @media (max-width:900px){.grid-2,.grid-3{grid-template-columns:1fr}}
    label{display:block;font-weight:600;margin-bottom:6px}
    input[type=text],input[type=number],input[type=file]{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px;background:#fff;outline:none}
    input:focus{border-color:#93c5fd;box-shadow:0 0 0 3px rgba(147,197,253,.3)}
    .radio-group{display:flex;gap:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}
    button{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#111827;color:#fff;cursor:pointer}
    button.secondary{background:#fff;color:#111827}
    button:disabled{opacity:.6;cursor:not-allowed}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left;vertical-align:top}
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .chip.ok{background:#dcfce7;color:#166534;border:1px solid #86efac}
    .chip.no{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin-left:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  </style>
</head>
<body>
<div class="container">
  <h2>Импорт Приёмки в МойСклад</h2>

  <div class="card grid grid-3">
    <div><label>Организация</label><input id="org" type="text" placeholder="West-parts"></div>
    <div><label>Склад</label><input id="store" type="text" placeholder="Основной"></div>
    <div><label>Поставщик (для сверки ЗП)</label><input id="agent" type="text" placeholder="Ebay"></div>
  </div>

  <div class="card grid grid-2">
    <div>
      <label>Валюта</label>
      <div class="radio-group">
        <label><input type="radio" name="currency" value="usd" checked> Доллар</label>
        <label><input type="radio" name="currency" value="kgs"> Сом</label>
      </div>
      <p class="muted" style="margin:6px 0 0">Если в файле есть колонка «Валюта», она приоритетнее переключателя.</p>
    </div>
    <div class="grid grid-3">
      <div id="usdWrap"><label>Курс $</label><input id="usdRate" type="number" step="0.0001" min="0" placeholder="например, 87"></div>
      <div><label>Коэффициент</label><input id="coef" type="number" step="0.01" min="0" value="1.6"></div>
      <div id="shipWrap"><label>Доставка $/кг</label><input id="ship" type="number" step="0.01" min="0" value="15"></div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div style="flex:1;min-width:260px">
        <label>Файл поставщика</label>
        <input id="file" type="file">
        <div class="muted" style="margin-top:6px">Рекомендуется <b>.xlsx</b>. Старый <b>.xls</b> может не читаться — сохраните как .xlsx.</div>
      </div>
      <div class="row">
        <button id="previewBtn" type="button" class="secondary">Превью</button>
        <button id="importBtn" type="button">Создать приёмку</button>
        <span id="status" class="muted"></span>
      </div>
    </div>
  </div>

  <div class="card" id="results" style="display:none">
    <h3>Результаты</h3>
    <div id="summary" class="muted" style="margin:8px 0 12px"></div>
    <div style="overflow:auto">
      <table id="table"><thead></thead><tbody></tbody></table>
    </div>
  </div>

  <div class="card" id="debugBox" style="display:none">
    <details>
      <summary>Технические детали (JSON)</summary>
      <pre id="debug" class="mono" style="white-space:pre-wrap"></pre>
    </details>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const $ = (id) => document.getElementById(id);
  const orgEl=$('org'), storeEl=$('store'), agentEl=$('agent');
  const usdRateEl=$('usdRate'), coefEl=$('coef'), shipEl=$('ship');
  const fileEl=$('file'), outEl=$('out'), hintEl=$('hint');
  const curRadios=document.querySelectorAll('input[name="currency"]');

  let lastRows=[], weights={};

  function getCur(){ for(const r of curRadios) if(r.checked) return r.value; return 'usd'; }

  function kgsForRow(currency, price, weight){
    const coef=parseFloat(coefEl.value||'1.6');
    const ship=parseFloat(shipEl.value||'15');
    const rate=parseFloat(usdRateEl.value||'0');
    if(price==null||isNaN(price)) return null;
    const w=weight?parseFloat(weight):0;
    if(String(currency).toLowerCase()==='usd'){
      if(!rate) return null;
      // (цена*коэфф + вес*доставка) * курс
      return (price*coef + w*ship) * rate;
    }else{
      return price*coef;
    }
  }

  function buildQuery({withPriceParams, weightsJson}){
    const q=new URLSearchParams();
    if(orgEl?.value) q.set('organization_name', orgEl.value.trim());
    if(storeEl?.value) q.set('store_name', storeEl.value.trim());
    if(agentEl?.value) q.set('agent_name', agentEl.value.trim());
    q.set('auto_create_products','true');
    q.set('auto_create_agent','true');

    const currency=getCur();
    q.set('price_currency', currency);

    if(withPriceParams){
      q.set('coef', String(parseFloat(coefEl.value||'1.6')));
      q.set('shipping_per_kg_usd', String(parseFloat(shipEl.value||'15')));
      if(currency==='usd'){
        const rate=parseFloat(usdRateEl.value||'0');
        if(rate>0) q.set('usd_rate', String(rate));
      }
    }
    if(weightsJson) q.set('weights_json', weightsJson);
    return q;
  }

  function renderTable(rows){
    lastRows=rows.slice();
    weights={};
    let html=`
      <div style="overflow:auto">
      <table style="width:100%;border-collapse:collapse">
      <thead>
        <tr>
          <th style="text-align:left;padding:6px 8px;border-bottom:1px solid #e2e8f0;">Артикул (станет code)</th>
          <th style="text-align:left;padding:6px 8px;border-bottom:1px solid #e2e8f0;">Наименование</th>
          <th style="text-align:right;padding:6px 8px;border-bottom:1px solid #e2e8f0;">Кол-во</th>
          <th style="text-align:right;padding:6px 8px;border-bottom:1px solid #e2e8f0;">Цена (raw)</th>
          <th style="text-align:center;padding:6px 8px;border-bottom:1px solid #e2e8f0;">Валюта</th>
          <th style="text-align:right;padding:6px 8px;border-bottom:1px solid #e2e8f0;">Вес, кг</th>
          <th style="text-align:right;padding:6px 8px;border-bottom:1px solid #e2e8f0;">Цена (KGS)</th>
          <th style="text-align:center;padding:6px 8px;border-bottom:1px solid #e2e8f0;">Совпадение в ЗП</th>
        </tr>
      </thead><tbody>
    `;
    rows.forEach((r, i)=>{
      const code=String(r.article||'').trim();
      const w = r.weight ?? '';
      weights[code] = (w===''||w==null)?undefined:Number(w);
      const pkgs = r.price_kgs==null?'—':`${r.price_kgs} c`;
      const tag = r.in_po
        ? '<span style="background:#dcfce7;color:#166534;padding:2px 8px;border-radius:999px;">найден</span>'
        : '<span style="background:#fee2e2;color:#991b1b;padding:2px 8px;border-radius:999px;">нет</span>';
      html+=`
        <tr data-idx="${i}">
          <td style="padding:6px 8px;border-bottom:1px solid #f1f5f9;">${code}</td>
          <td style="padding:6px 8px;border-bottom:1px solid #f1f5f9;">${r.name||''}</td>
          <td style="padding:6px 8px;border-bottom:1px solid #f1f5f9;text-align:right;">${r.qty||0}</td>
          <td style="padding:6px 8px;border-bottom:1px solid #f1f5f9;text-align:right;">${r.price_raw ?? '—'}</td>
          <td style="padding:6px 8px;border-bottom:1px solid #f1f5f9;text-align:center;">${(r.currency||'').toUpperCase()}</td>
          <td style="padding:6px 8px;border-bottom:1px solid #f1f5f9;text-align:right;">
            <input type="number" step="0.001" min="0" value="${w ?? ''}" style="width:100px;padding:6px 8px;border:1px solid #e2e8f0;border-radius:8px;" class="w-input" data-code="${code}">
          </td>
          <td style="padding:6px 8px;border-bottom:1px solid #f1f5f9;text-align:right;" class="pkgs">${pkgs}</td>
          <td style="padding:6px 8px;border-bottom:1px solid #f1f5f9;text-align:center;">${tag}</td>
        </tr>`;
    });
    html+='</tbody></table></div>';
    outEl.innerHTML=html;

    outEl.querySelectorAll('.w-input').forEach(inp=>{
      inp.addEventListener('input', e=>{
        const code=e.target.getAttribute('data-code')||'';
        const tr=e.target.closest('tr');
        const idx=Number(tr.getAttribute('data-idx'));
        const row=lastRows[idx];
        const val=e.target.value.trim();
        weights[code]=val===''?undefined:Number(val);
        const kgs=kgsForRow(row.currency, row.price_raw, weights[code] ?? row.weight ?? 0);
        tr.querySelector('.pkgs').textContent = (kgs==null||isNaN(kgs)) ? '—' : `${Math.round(kgs)} c`;
      });
    });
  }

  async function callPreview(){
    outEl.textContent='Загрузка...'; hintEl.textContent='';
    const f=fileEl?.files?.[0]; if(!f){ outEl.textContent='Выберите файл.'; return; }

    // если выбран USD — требуем курс
    if(getCur()==='usd' && !(parseFloat(usdRateEl.value||'0')>0)){
      outEl.textContent='Укажите курс USD.';
      return;
    }

    const form=new FormData(); form.append('file', f);
    const q=buildQuery({withPriceParams:true, weightsJson: JSON.stringify(weights)});
    const resp=await fetch(`/import-invoice-preview/?${q.toString()}`, {method:'POST', body:form});
    let data; try{ data=await resp.json(); }catch{ data={error:await resp.text()}; }

    if(resp.ok && Array.isArray(data.rows)){
      renderTable(data.rows);
      hintEl.textContent=`Строк: ${data.rows_total}. Совпадений в ЗП: ${data.rows.filter(r=>r.in_po).length}.`;
    }else{
      outEl.textContent=JSON.stringify(data,null,2);
    }
  }

  async function callImport(){
    hintEl.textContent='Отправка...';
    const f=fileEl?.files?.[0]; if(!f){ hintEl.textContent='Выберите файл.'; return; }

    if(getCur()==='usd' && !(parseFloat(usdRateEl.value||'0')>0)){
      hintEl.textContent='Укажите курс USD.'; return;
    }

    const form=new FormData(); form.append('file', f);
    const q=buildQuery({withPriceParams:true, weightsJson: JSON.stringify(weights)});
    const resp=await fetch(`/import-invoice-to-supply/?${q.toString()}`, {method:'POST', body:form});
    let data; try{ data=await resp.json(); }catch{ data={error:await resp.text()}; }

    if(resp.ok){
      hintEl.textContent='Готово. Документ Приёмки создан.'; 
      outEl.textContent=JSON.stringify(data,null,2);
    }else{
      hintEl.textContent='Ошибка'; 
      outEl.textContent=JSON.stringify(data,null,2);
    }
  }

  document.getElementById('previewBtn')?.addEventListener('click', callPreview);
  document.getElementById('importBtn')?.addEventListener('click', callImport);
});
</script>
</body>
</html>