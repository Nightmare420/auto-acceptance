<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Импорт Приёмки — МойСклад</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f8fafc; --card:#fff; --text:#0f172a; --muted:#64748b; --border:#e2e8f0; --ok:#16a34a; --danger:#ef4444; --radius:12px; --space:14px; --maxw:1100px; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;display:flex;justify-content:center}
    .container{width:100%;max-width:var(--maxw);padding:24px 16px}
    h2{margin:0 0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;box-shadow:0 1px 2px rgba(16,24,40,.04);margin-bottom:16px}
    .grid{display:grid;gap:var(--space)} .grid-2{grid-template-columns: repeat(2,minmax(0,1fr))} .grid-3{grid-template-columns: repeat(3,minmax(0,1fr))}
    @media (max-width:900px){.grid-2,.grid-3{grid-template-columns:1fr}}
    label{display:block;font-weight:600;margin-bottom:6px}
    input[type=text],input[type=number],input[type=file]{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px;background:#fff;outline:none}
    input:focus{border-color:#93c5fd;box-shadow:0 0 0 3px rgba(147,197,253,.3)}
    .radio-group{display:flex;gap:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}
    button{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#111827;color:#fff;cursor:pointer}
    button.secondary{background:#fff;color:#111827}
    button:disabled{opacity:.6;cursor:not-allowed}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left;vertical-align:top}
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .chip.ok{background:#dcfce7;color:#166534;border:1px solid #86efac}
    .chip.no{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  </style>
</head>
<body>
<div class="container">
  <h2>Импорт Приёмки в МойСклад</h2>

  <div class="card grid grid-3">
    <div><label>Организация</label><input id="org" type="text" placeholder="West-parts"></div>
    <div><label>Склад</label><input id="store" type="text" placeholder="Основной склад"></div>
    <div><label>Контрагент</label><input id="agent" type="text" placeholder="Ebay"></div>
  </div>

  <div class="card grid grid-3">
    <div>
      <label>Валюта</label>
      <div class="radio-group">
        <label><input type="radio" name="currency" value="usd" checked> Доллар</label>
        <label><input type="radio" name="currency" value="kgs"> Сом</label>
      </div>
    </div>
    <div><label>Курс $</label><input id="usdRate" type="number" step="0.0001" min="0" placeholder="например, 87"></div>
    <div><label>Коэффициент</label><input id="coef" type="number" step="0.01" min="0" value="1.6"></div>
    <div><label>Доставка $/кг</label><input id="ship" type="number" step="0.01" min="0" value="15"></div>
  </div>

  <div class="card">
    <div class="row">
      <div style="flex:1;min-width:260px">
        <label>Файл поставщика</label>
        <input id="file" type="file">
        <div class="muted" style="margin-top:6px">Рекомендуется <b>.xlsx</b>. Старый <b>.xls</b> может не читаться — сохраните как .xlsx.</div>
      </div>
      <div class="row">
        <button id="previewBtn" type="button" class="secondary">Превью</button>
        <button id="importBtn" type="button">Создать приёмку</button>
        <span id="status" class="muted"></span>
      </div>
    </div>
  </div>

  <div class="card" id="results" style="display:none">
    <h3>Результаты</h3>
    <div id="summary" class="muted" style="margin:8px 0 12px"></div>
    <div style="overflow:auto">
      <table id="mainTable">
        <thead>
          <tr>
            <th>Артикул (станет code)</th>
            <th>Наименование (файл)</th>
            <th>Кол-во</th>
            <th>Ед.</th>
            <th>Цена из файла</th>
            <th>Вес (кг)</th>
            <th>Розничная цена</th>
            <th>В заказах поставщика</th>
            <th>Товар</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card" id="poMatches" style="display:none">
    <h3>Совпадения с заказами поставщика</h3>
    <div id="poSummary" class="muted" style="margin:6px 0 10px"></div>
    <label class="muted" style="display:block;margin:0 0 10px">
      <input type="checkbox" id="showDone"> Показывать заказы со статусом «Выполнен»
    </label>
    <div style="overflow:auto">
      <table id="poTable">
        <thead>
          <tr>
            <th>Артикул</th>
            <th>Наименование (файл)</th>
            <th>Наименование (МС)</th>
            <th>№ заказа (с датой создания)</th>
            <th>Статус</th>
            <th>Дата</th>
            <th>Создан</th>
            <th>Обновлён</th>
            <th>Кол-во в ЗП</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div>

<script>
(function () {
  function $(id){ return document.getElementById(id); }
  function esc(s){ return String(s ?? '').replace(/</g,'&lt;'); }

  function normStateName(v){
    if (!v) return '';
    if (typeof v === 'string') return v;
    if (typeof v === 'object') return v.name || v.title || v.value || '';
    return '';
  }
  function isDoneState(v){
    const s = normStateName(v).trim().toLowerCase();
    return ['выполнен','выполнено','выполнена','completed','исполнен'].includes(s);
  }
  function statusBadge(v){
    const name = normStateName(v);
    if (!name) return '';
    const cls = isDoneState(v) ? 'no' : 'ok';
    return `<span class="chip ${cls}">${name}</span>`;
  }

  function fmtDate(raw){
    if (!raw) return '';
    return String(raw).replace('T',' ').replace('Z','').replace(/\.\d+$/,'');
  }

  const orgEl   = $('org');
  const storeEl = $('store');
  const agentEl = $('agent');
  const usdRateEl = $('usdRate');
  const coefEl    = $('coef');
  const shipEl    = $('ship');
  const fileEl    = $('file');
  const statusEl  = $('status');

  const previewBtn = $('previewBtn');
  const importBtn  = $('importBtn');
  const showDoneEl = $('showDone');

  const curRadios = document.querySelectorAll('input[name="currency"]');

  let rowsCache = [];
  let poMatchesCache = [];
  const weightsMap = {};
  const pricesMap  = {};

  function getCur() {
    for (const r of curRadios) if (r.checked) return r.value;
    return 'usd';
  }

  function qParams(withPrice) {
    const q = new URLSearchParams();
    if (orgEl.value)   q.set('organization_name', orgEl.value.trim());
    if (storeEl.value) q.set('store_name',        storeEl.value.trim());
    if (agentEl.value) q.set('agent_name',        agentEl.value.trim());
    q.set('auto_create_products', 'true');
    q.set('auto_create_agent', 'true');
    q.set('price_currency', getCur());
    q.set('coef', String(parseFloat(coefEl.value || '1.6') || 1.6));
    if (withPrice && getCur()==='usd') {
      const rate = parseFloat(usdRateEl.value || '');
      if (!rate) throw new Error('Укажите курс доллара');
      q.set('usd_rate', String(rate));
      q.set('shipping_per_kg_usd', String(parseFloat(shipEl.value || '15') || 0));
    }
    return q;
  }

  function setLoading(btn, is) {
    if (btn) {
      btn.disabled = !!is;
      if (is) { btn.dataset.t = btn.textContent; btn.textContent = 'Загрузка…'; }
      else    { btn.textContent = btn.dataset.t || btn.textContent; }
    }
    if (btn !== previewBtn) previewBtn.disabled = !!is;
    if (btn !== importBtn)  importBtn.disabled = !!is;
  }

  function q2(x){ return Math.round((x + Number.EPSILON) * 100) / 100; }

  function computePriceKgs(row, weight) {
    const price = parseFloat((row.price_raw === undefined || row.price_raw === null) ? NaN : row.price_raw);
    const coef  = parseFloat(coefEl.value || '1') || 1;
    if (!isFinite(price)) return null;
    if (getCur() === 'usd') {
      const rate = parseFloat(usdRateEl.value || '0') || 0;
      const ship = parseFloat(shipEl.value || '0')   || 0;
      const w    = parseFloat(weight || '0')         || 0;
      if (!rate) return null;
      return q2((price * coef + w * ship) * rate);
    } else {
      return q2(price * coef);
    }
  }

  async function callApi(path, btn) {
    const f = (fileEl.files && fileEl.files[0]) || null;
    if (!f) { statusEl.textContent = 'Выберите файл.'; return; }

    let q; try { q = qParams(true); } catch (e) {
      statusEl.textContent = e.message; return;
    }

    const form = new FormData();
    form.append('file', f);

    if (path.includes('import-invoice-to-supply')) {
      form.append('weights', JSON.stringify(weightsMap));
      form.append('prices_kgs', JSON.stringify(pricesMap));
      form.append('organization_name', (orgEl.value || '').trim());
      form.append('store_name',        (storeEl.value || '').trim());
      form.append('agent_name',        (agentEl.value || '').trim());
      form.append('price_currency', getCur());
      form.append('coef', String(parseFloat(coefEl.value || '1.6') || 1.6));
      if (getCur() === 'usd') {
        const rate = parseFloat(usdRateEl.value || '');
        if (!rate) { setLoading(btn,false); statusEl.textContent = 'Укажите курс доллара'; return; }
        form.append('usd_rate', String(rate));
        form.append('shipping_per_kg_usd', String(parseFloat(shipEl.value || '15') || 0));
      }
    }

    setLoading(btn, true); statusEl.textContent = '';
    let data;
    try {
      const resp = await fetch(path + '?' + q.toString(), { method: 'POST', body: form });
      const ct = resp.headers.get('content-type') || '';
      data = (ct.includes('json')) ? await resp.json() : { error: await resp.text() };
      if (!resp.ok) throw data;
    } catch (e) {
      console.error(e);
      statusEl.textContent = (e && e.detail) || (e && e.error) || 'Ошибка сети';
      setLoading(btn, false);
      return;
    }
    setLoading(btn, false);

    if (path.includes('preview')) {
      rowsCache = data.rows || [];
      poMatchesCache = data.po_matches || [];
      for (const k in weightsMap) delete weightsMap[k];
      for (const k2 in pricesMap) delete pricesMap[k2];

      renderMainTable(rowsCache);
      renderPoMatches(rowsCache, poMatchesCache);
      $('results').style.display = '';
      $('poMatches').style.display = (poMatchesCache.length) ? '' : 'none';
      $('summary').textContent = 'Строк: ' + (data.rows_total ?? rowsCache.length) + '. Создадим: ' + (data.will_create_count ?? 0) +
        '. Уже есть: ' + (data.will_use_existing_count ?? 0) + '. Совпадений с заказами поставщика: ' + poMatchesCache.length + '.';
      statusEl.textContent = '';
    } else {
      statusEl.textContent = 'Готово. Документ Приёмки создан.';
    }
  }

  function renderMainTable(rows) {
    const tb = document.querySelector("#mainTable tbody");
    tb.innerHTML = "";
    rows.forEach((r, idx) => {
      const priceText = (r.price_kgs != null) ? r.price_kgs : "";
      const tr = document.createElement("tr");
      tr.innerHTML =
        '<td class="mono">'+esc(r.article || "")+'</td>'+
        '<td>'+esc(r.name || "")+'</td>'+
        '<td>'+((r.qty ?? '') )+'</td>'+
        '<td>'+esc(r.unit || "")+'</td>'+
        '<td>'+((r.price_raw ?? '') )+'</td>'+
        '<td><input type="number" min="0" step="0.001" class="weightInput" data-row="'+idx+'" style="width:90px"/></td>'+
        '<td class="priceKgs" data-row="'+idx+'">'+(priceText === "" ? "" : priceText)+'</td>'+
        '<td>'+(r.po_hit ? '<span class="chip ok">есть</span>' : '<span class="chip no">нет</span>')+'</td>'+
        '<td>'+(r.will_create ? '<span class="chip no">создадим</span>' : '<span class="chip ok">существует</span>')+'</td>';
      tb.appendChild(tr);
    });
  }

  document.addEventListener('input', function(e){
    if (!e.target.classList?.contains('weightInput')) return;
    const idx = parseInt(e.target.dataset.row, 10);
    if (!rowsCache[idx]) return;
    const w = e.target.value;
    weightsMap[idx] = parseFloat(w || '0') || 0;
    const price = computePriceKgs(rowsCache[idx], weightsMap[idx]);
    const cell = document.querySelector('.priceKgs[data-row="'+idx+'"]');
    if (price == null) {
      cell.textContent = '';
      delete pricesMap[idx];
    } else {
      cell.textContent = price.toFixed(2);
      pricesMap[idx] = price;
    }
  });

  function recalcAll() {
    document.querySelectorAll('.weightInput').forEach(inp => {
      const idx = parseInt(inp.dataset.row, 10);
      const w = parseFloat(inp.value || '0') || 0;
      weightsMap[idx] = w;
      const price = computePriceKgs(rowsCache[idx], w);
      const cell = document.querySelector('.priceKgs[data-row="'+idx+'"]');
      if (cell) {
        if (price == null) { cell.textContent = ''; delete pricesMap[idx]; }
        else { cell.textContent = price.toFixed(2); pricesMap[idx] = price; }
      }
    });
  }
  curRadios.forEach(r => r.addEventListener('change', recalcAll));
  ['usdRate','coef','ship'].forEach(id => $(id).addEventListener('input', recalcAll));

  function renderPoMatches(previewRows, poMatches){
    const box = $('poMatches');
    const sum = $('poSummary');
    const tb  = document.querySelector('#poTable tbody');
    const showDone = showDoneEl?.checked;

    if (!poMatches || !poMatches.length){
      box.style.display = 'none';
      return;
    }

    const nameByCode = {};
    for (const r of (previewRows||[])){
      if (r?.article) nameByCode[String(r.article).toLowerCase()] = r.name || '';
    }

    tb.innerHTML = '';

    let totalRows = 0;
    let hiddenDone = 0;

    for (const m of poMatches){
      const code = String(m.article || '');
      const nameFile = nameByCode[code.toLowerCase()] || '';
      const nameMs   = m.name_from_ms || '';
      const qtyInPo  = (m.qty_in_po ?? 0);
      const rawOrders = Array.isArray(m.orders) ? m.orders : [];

      const normOrders = rawOrders.map(o => ({
        number:  o.number || o.name || '',
        href:    o.href || o.meta?.uuidHref || '',
        moment:  o.moment || o.momentDate || '',
        created: o.created || o.createdAt || o.created_at || '',
        updated: o.updated || o.updatedAt || o.updated_at || '',
        state:   o.state || o.stateName || o.state_name || ''
      }));

      const visible = normOrders.filter(o => showDone || !isDoneState(o.state));
      hiddenDone += normOrders.length - visible.length;

      if (visible.length === 0 && normOrders.length === 0){
        const tr0 = document.createElement('tr');
        tr0.innerHTML =
          `<td class="mono">${esc(code)}</td>`+
          `<td>${esc(nameFile)}</td>`+
          `<td>${esc(nameMs)}</td>`+
          `<td></td><td></td><td></td><td></td><td></td>`+
          `<td>${qtyInPo}</td>`;
        tb.appendChild(tr0);
        continue;
      }

      if (visible.length === 0) continue;

      for (const o of visible){
        totalRows++;
        const numCell = o.href
          ? `<a href="${o.href}" target="_blank">${esc(o.number)}</a> <span class="muted" style="white-space:nowrap">· ${esc(fmtDate(o.created))}</span>`
          : `${esc(o.number)} <span class="muted" style="white-space:nowrap">· ${esc(fmtDate(o.created))}</span>`;

        const tr = document.createElement('tr');
        tr.innerHTML =
          `<td class="mono">${esc(code)}</td>`+
          `<td>${esc(nameFile)}</td>`+
          `<td>${esc(nameMs)}</td>`+
          `<td>${numCell}</td>`+
          `<td>${statusBadge(o.state)}</td>`+
          `<td>${esc(fmtDate(o.moment))}</td>`+
          `<td>${esc(fmtDate(o.created))}</td>`+
          `<td>${esc(fmtDate(o.updated))}</td>`+
          `<td>${qtyInPo}</td>`;
        tb.appendChild(tr);
      }
    }

    sum.textContent =
      `Найдено совпадений: ${poMatches.length}. `+
      `Показано строк: ${totalRows}`+
      (hiddenDone ? ` (без «Выполнен»: ${hiddenDone})` : '');

    box.style.display = '';
  }

  if (showDoneEl){
    showDoneEl.addEventListener('change', () => {
      renderPoMatches(rowsCache, poMatchesCache);
    });
  }

  previewBtn?.addEventListener('click', () => callApi('/import-invoice-preview/', previewBtn));
  importBtn?.addEventListener('click',  () => callApi('/import-invoice-to-supply/', importBtn));
})();
</script>
</body>
</html>